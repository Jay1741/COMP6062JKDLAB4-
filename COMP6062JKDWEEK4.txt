/*Use of AI / Cognitive Assistance Software is not allowed in any evaluation, assessment or exercise.*/
/*=============================================================================
	File Name:	ELNC6011JKDLAB1.c  
	Author:		Jay Darji
	Date:		08/01/2026
	Modified:	None 
	Â© Fanshawe College, 2026

	Description: This program implements a multi-channel sensor sampling system 
			using the PIC18F45K22. It samples three analog sensors (Pressure, 
			Humidity, Temperature) via ADC, stores them in a rolling buffer, 
			calculates a 10-sample average, and displays the results to a 
			serial terminal via USART1.
=============================================================================*/

/* Preprocessor ===============================================================
   Hardware Configuration Bits ==============================================*/
#pragma config FOSC		= INTIO67
#pragma config PLLCFG	= OFF
#pragma config PRICLKEN = ON
#pragma config FCMEN	= OFF
#pragma config IESO		= OFF
#pragma config PWRTEN	= OFF 
#pragma config BOREN	= ON
#pragma config BORV		= 285 
#pragma config WDTEN	= OFF
#pragma config PBADEN	= OFF
#pragma config LVP		= ON
#pragma config MCLRE	= EXTMCLR

// Libraries ==================================================================
#include <xc.h>
#include <stdio.h>
#include <stdlib.h>

// Constants  =================================================================
#define TRUE	1	
#define FALSE	0	
#define SAMPLES 10
#define TEMP 0
#define HUMID 1
#define PRES 2
#define SENSORS 3
#define ADCCHAN ADCON0bits.CHS 
#define ADCGO ADCON0bits.GO
#define TX1BUSY PIR1bits.TX1IF

// Type Defs ==========================================================
typedef int sensor_t;
typedef char flag_t;
// Global Variables  ==========================================================
typedef struct 
{
	sensor_t current;
	int highLimit;
	int lowLimit;
	sensor_t samples[SAMPLES];
	int insert;
	flag_t avgRdy;
	
}sensorChannel_t;

sensorChannel_t sensor [ SENSORS ];

// Functions  =================================================================

/*>>> setOsc4mhz ===========================================================
Author:		Jay Darji
Date:		15/01/2001
Modified:	None
Desc:		This function sets the frequency at 4Mhz for internal Oscillator of Microcontroller
			then waits it still stabalize.
Input: 		None 
Returns:	None 
 ============================================================================*/
void setOsc4mhz(void)
{
	OSCCON = 0x53;
	while(!OSCCONbits.HFIOFS);
	
} // eo setOsc4mhz::

/*>>> setIOport: ===========================================================
Author:		Jay Darji
Date:		15/01/2026
Modified:	None
Desc:		Configures PORTA for analog inputs and PORTC for USART.
Input: 		None 
Returns:	None 
 ============================================================================*/
void setIOport(void)
{
	ANSELA = 0x07;
	LATA   = 0x0F;
	TRISA  = 0xFF;
	
	ANSELB = 0x00;
	LATB   = 0x00;
	TRISB  = 0xFF;
	
	ANSELC = 0x00;
	LATC   = 0x00;
	TRISC  = 0xBF;
	  
	ANSELD = 0x00;
	LATD   = 0x00;
	TRISD  = 0xFF;
	 
	ANSELE = 0x00;
	LATE   = 0x00;
	TRISE  = 0xFF;
} // setIOport::

/*>>> configAdc: ===========================================================
Author:		Jay Darji
Date:		29/01/2026
Modified:	None
Desc:		Configures ADC for 12 Tad, Fosc/8, and module ON.   
Input: 		None 
Returns:	None 
 ============================================================================*/
void configAdc(void)
{
	ADCON0 = 0x01;
    ADCON1 = 0x00;
    ADCON2 = 0x29;
 
} // eo configAdc::

/*>>> getAdcSample: ===========================================================
Author:		Jay Darji
Date:		29/01/2026
Modified:	None
Desc:		This function Selects a channel, starts conversion, and returns the result. 
Input: 		char chan - input for channel select
Returns:	ADRES - the sample value from register.
 ============================================================================*/
int getAdcSample(char chan)
{
	ADCCHAN = chan;
    ADCGO = TRUE;
    while(ADCGO);
    return ADRES;
    
} // eo getAdcSample::

/*>>>  configSp1: ===========================================================
Author:		Jay Darji
Date:		29/01/2026
Modified:	None
Desc:		This function configures the serial connection on port 1 for establishing coomunication 
            with MAX 232.It sets baud rate at  9600, SP1 on, TX & RX enabled, 8 bit, 1 stop bit, non-inverted.
Input: 		None 
Returns:	None 
 ============================================================================*/
void configSp1(void)
{
	TXSTA1 = 0x26;
    RCSTA1 = 0x80;
    BAUDCON1 = 0X40;
    SPBRGH1 = 0X00;
    SPBRG1 = 0X19;
       
} // eo configSp1::

void putch(char data)
{
    while(!TX1BUSY);
    TXREG1= data;
}// Required for printf to redirect output to USART1.

// Sensor Functions  =================================================================




/*>>> systemInitialization: ===========================================================
Author:		Jay Darji
Date:		29/01/2026
Modified:	None
Desc:		This function initialize all the functions for main.
Input: 		None 
Returns:	None 
 ============================================================================*/
void systemInitialization(void)
{
    setOsc4mhz();
    setIOport();
    configAdc();
    configSp1(); 
    
} // eo systemInitialization::

/*>>> printValue: ========================================================
Author:		Jay Darji
Date:		29/01/2026
Modified:	None
Desc:		This function transmits the formatted sensor data table via 
			USART1, including the student ID, current averages, and limits.
Input: 		None 
Returns:	None 
============================================================================*/
void printValue(void)
{
	printf("\033[2J\033[H"); // Clear Screen
	printf("System(933)\n\r");
	printf("Sen0:\t%i  Sen1:\t%i  Sen2:\t%i \n\r", sensor[TEMP].current, sensor[HUMID].current, sensor[PRES].current); // Display Averages	
	printf("HL:  \t%i  HL:\t  %i  HL:\t  %i \n\r", sensor[TEMP].highLimit, sensor[HUMID].highLimit, sensor[PRES].highLimit); // Display High Limits	
	printf("LL:  \t%i  LL:\t  %i  LL:\t  %i \n\r", sensor[TEMP].lowLimit, sensor[HUMID].lowLimit, sensor[PRES].lowLimit); // Display Low Limits
    
} // eo printValue::

// Sensor Functions  =================================================================

/*>>> initSensorData: ===========================================================
Author:		Jay Darji
Date:		08/01/2026
Modified:	None
Desc:		Function is intializes a data structure sensoreChennel_t by putting it to zero State.
Input: 		sensorChannel_t *ptr, A Pointer to a sensorChannel_t object.
Returns:	None
 ============================================================================*/
void initSensorData(sensorChannel_t *ptr)
{
	int index = 0;
	ptr -> current = FALSE;
	ptr -> highLimit = FALSE;
	ptr -> lowLimit = FALSE;
	for (index = 0; index < SAMPLES;index++)
	{
		ptr -> samples[index] = FALSE;
	}
	ptr -> insert = FALSE;
	ptr -> avgRdy = FALSE;
} // eo initSensorData::



/*=== MAIN: FUNCTION ==========================================================
 ============================================================================*/
void main(void)
{
	char chID = 0;
	long sum = 0;
	int index = 0;
	
	systemInitialization();
	
	for (chID = 0; chID < SENSORS; chID++)
	{
		initSensorData(&sensor[chID]);
	} // eo for loop
	
	while(TRUE)
	{  
		for (chID = 0; chID < SENSORS; chID++)
		{
			sum = 0;
			 
			sensor[chID].samples[sensor[chID].insert] = getAdcSample(chID);
			sensor[chID].insert++;
			
			if(sensor[chID].insert >= SAMPLES)
			{
				sensor[chID].insert = FALSE;
				sensor[chID].avgRdy = TRUE;
			} // eo if
			
			if (sensor[chID].avgRdy == TRUE)
			{
				for(index = 0; index < SAMPLES; index++) 
				{
					sum += sensor[chID].samples[index];
				} // eo for loop
				
				sensor[chID].current = (sum / SAMPLES);
			} // eo if
		} // eo for loop
		
		printValue(); 
		
	} // eo while loop
   
} // eo main::
